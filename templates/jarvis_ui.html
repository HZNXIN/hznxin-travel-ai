<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS TRAVEL COMMAND CENTER</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- È´òÂæ∑Âú∞ÂõæJS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=c0879532b66de630ce0e0937e828fa12"></script>
    <style>
        /* --- ÂÖ®Â±ÄÂü∫Á°ÄËÆæÁΩÆ --- */
        :root {
            --primary-color: #00f3ff;
            --warning-color: #ff3333;
            --bg-color: #050a14;
            --glass-bg: rgba(0, 243, 255, 0.05);
            --border-glow: 0 0 10px rgba(0, 243, 255, 0.4);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--primary-color);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .main-container {
            display: grid;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            padding: 10px;
            gap: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 25% 45% 30%;
            gap: 15px;
            height: 100%;
        }

        /* --- È°∂ÈÉ®Áä∂ÊÄÅÊ†è --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary-color);
            padding: 0 20px;
            background: rgba(0,0,0,0.5);
            box-shadow: var(--border-glow);
        }
        .system-status span { margin-left: 20px; font-weight: bold; }
        .blink { animation: blinker 1s linear infinite; color: var(--warning-color); }

        /* --- ÈÄöÁî® JARVIS ÁõíÂ≠êÊ†∑Âºè --- */
        .jarvis-box {
            background: var(--glass-bg);
            border: 1px solid rgba(0, 243, 255, 0.3);
            position: relative;
            padding: 15px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(4px);
            transition: all 0.3s;
        }
        
        .jarvis-box::before, .jarvis-box::after,
        .corner-br::before, .corner-br::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            border-color: var(--primary-color); border-style: solid; transition: all 0.3s;
        }
        .jarvis-box::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
        .jarvis-box::after { top: -1px; right: -1px; border-width: 2px 2px 0 0; }
        .corner-br { position: absolute; bottom: 0; right: 0; width: 100%; height: 100%; pointer-events: none; }
        .corner-br::before { bottom: -1px; left: -1px; border-width: 0 0 2px 2px; }
        .corner-br::after { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }

        .box-title {
            font-size: 1.2rem;
            border-bottom: 1px solid rgba(0, 243, 255, 0.3);
            padding-bottom: 5px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 5px var(--primary-color);
        }

        /* --- Â∑¶‰æßÊ®°Âùó --- */
        .col-left { display: flex; flex-direction: column; gap: 15px; }
        
        #radar-chart { flex: 1; min-height: 200px; }
        
        .terminal-log {
            flex: 1;
            background: rgba(0,0,0,0.6);
            border: 1px solid #333;
            padding: 10px;
            font-size: 0.8rem;
            overflow-y: auto;
            color: #0f0;
            max-height: 300px;
        }
        .log-line { margin: 2px 0; opacity: 0.8; }

        /* --- ‰∏≠Èó¥Ê®°Âùó --- */
        .col-center { display: flex; flex-direction: column; gap: 15px; position: relative; }
        
        .hologram-map {
            flex: 2;
            background: radial-gradient(circle at center, #002244 0%, #000 100%);
            border: 1px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .map-grid {
            position: absolute; width: 200%; height: 200%;
            background-image: linear-gradient(var(--primary-color) 1px, transparent 1px),
            linear-gradient(90deg, var(--primary-color) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.1;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 10s linear infinite;
        }

        .ai-core-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .ai-circle {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px var(--primary-color), inset 0 0 20px var(--primary-color);
            position: relative;
            animation: pulse 2s infinite;
        }
        .ai-circle::after {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 50%; border: 1px dashed white;
            animation: spin 10s linear infinite;
        }
        .ai-text { margin-top: 15px; font-size: 1.2rem; text-align: center; }

        /* --- Âè≥‰æßÊ®°Âùó --- */
        .col-right { display: flex; flex-direction: column; gap: 15px; overflow-y: hidden; }

        .timeline-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); }

        .timeline-item {
            display: flex;
            margin-bottom: 20px;
            position: relative;
            padding-left: 20px;
            border-left: 2px solid rgba(0, 243, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        .timeline-item:hover {
            border-left-color: var(--primary-color);
            transform: translateX(5px);
        }
        .timeline-item::before {
            content: ''; position: absolute; left: -6px; top: 5px;
            width: 10px; height: 10px; background: var(--primary-color);
            border-radius: 50%; box-shadow: 0 0 10px var(--primary-color);
        }
        .timeline-item.selected {
            background: rgba(0, 243, 255, 0.1);
            border-left: 3px solid var(--primary-color);
        }
        .time { font-size: 0.9rem; color: #fff; width: 60px; }
        .event { color: var(--primary-color); }
        .event-detail { font-size: 0.8rem; color: #aaa; margin-top: 5px; }
        .event-score { font-size: 0.75rem; color: #ffff00; margin-top: 3px; }

        .resource-card {
            display: flex;
            background: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            padding: 10px;
            border-left: 3px solid var(--primary-color);
        }
        .card-img { width: 60px; height: 60px; background: #333; margin-right: 10px; display: flex; align-items: center; justify-content: center;}

        /* --- Âä®ÁîªÂÆö‰πâ --- */
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 10px var(--primary-color); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px var(--primary-color); }
            100% { transform: scale(0.95); box-shadow: 0 0 10px var(--primary-color); }
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes blinker { 50% { opacity: 0; } }
        @keyframes gridMove { 0% { transform: perspective(500px) rotateX(60deg) translateY(0); } 100% { transform: perspective(500px) rotateX(60deg) translateY(50px); } }

        .scanline {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.5) 51%);
            background-size: 100% 4px; pointer-events: none; z-index: 999; opacity: 0.3;
        }

        /* ÊéßÂà∂ÊåâÈíÆ */
        .control-btn {
            background: rgba(0, 243, 255, 0.2);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }
        .control-btn:hover {
            background: rgba(0, 243, 255, 0.4);
            box-shadow: 0 0 15px var(--primary-color);
        }
        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

    </style>
</head>
<body>

    <div class="scanline"></div>

    <div class="main-container">
        <!-- È°∂Ê†è -->
        <div class="top-bar">
            <div class="app-title">ü§ñ JARVIS TRAVEL AGENT <span style="font-size:0.8em; opacity:0.7">v3.0 4D</span></div>
            <div class="system-status">
                <span>DEST: <span id="dest-city">ËãèÂ∑û</span></span>
                <span>RISK: <span class="blink" id="risk-level">LOW</span></span>
                <span>BUDGET: ¬•<span id="budget-left">5000</span></span>
                <span id="realtime-clock">12:00:00</span>
            </div>
        </div>

        <div class="dashboard-grid">
            
            <!-- [Â∑¶Ê†è] ÊÄÅÂäøÊÑüÁü• -->
            <div class="col-left">
                <!-- Â®ÅËÉÅÈõ∑Ëææ -->
                <div class="jarvis-box">
                    <div class="corner-br"></div>
                    <div class="box-title">TENSION RADAR // Âº†ÂäõÈõ∑Ëææ</div>
                    <div id="radar-chart"></div>
                </div>

                <!-- ÂÆûÊó∂ÁªàÁ´ØÊó•Âøó -->
                <div class="jarvis-box" style="flex:1">
                    <div class="corner-br"></div>
                    <div class="box-title">SYSTEM LOG // ÁªàÁ´Ø</div>
                    <div class="terminal-log" id="terminal">
                        <div class="log-line">> System initialized...</div>
                        <div class="log-line">> Waiting for session start...</div>
                    </div>
                </div>

                <!-- Á≥ªÁªüÊéßÂà∂ -->
                <div class="jarvis-box">
                    <div class="corner-br"></div>
                    <div class="box-title">SYSTEM CONTROL</div>
                    <button class="control-btn" onclick="startSession()">üöÄ START MISSION</button>
                    <button class="control-btn" onclick="getNextOptions()" id="btn-next" disabled>‚û°Ô∏è GET OPTIONS</button>
                    <button class="control-btn" onclick="selectOption()" id="btn-select" disabled>‚úÖ CONFIRM</button>
                </div>
            </div>

            <!-- [‰∏≠Ê†è] Ê†∏ÂøÉÊåáÊå• -->
            <div class="col-center">
                <!-- ÂÖ®ÊÅØÂú∞Âõæ -->
                <div class="jarvis-box hologram-map">
                    <div class="corner-br"></div>
                    <!-- üó∫Ô∏è ÁúüÂÆûÈ´òÂæ∑Âú∞Âõæ -->
                    <div id="gaode-map" style="width:100%; height:100%; position:absolute; top:0; left:0; opacity:0.8;"></div>
                    <div style="position:absolute; top:10px; left:10px; z-index:20; font-size:1.2rem; text-shadow:0 0 10px black; background:rgba(0,0,0,0.5); padding:5px 10px; border:1px solid #00f3ff">
                        MAP VISUALIZATION
                    </div>
                </div>

                <!-- AI ÊÄùËÄÉÊ†∏ÂøÉ -->
                <div class="jarvis-box ai-core-container">
                    <div class="corner-br"></div>
                    <div class="ai-circle"></div>
                    <div class="ai-text">
                        <span id="ai-status">STANDBY</span><br>
                        <span style="font-size:0.8rem; color:#aaa" id="ai-reasoning">Á≠âÂæÖÂêØÂä®‰ªªÂä°...</span>
                    </div>
                </div>
            </div>

            <!-- [Âè≥Ê†è] Ë°åÂä®ÊñπÊ°à -->
            <div class="col-right">
                <div class="jarvis-box" style="flex:2">
                    <div class="corner-br"></div>
                    <div class="box-title">MISSION TIMELINE // Ë°åÁ®ã</div>
                    <div class="timeline-container" id="timeline">
                        <div style="text-align:center; color:#aaa; padding:20px;">
                            ÁÇπÂáª START MISSION ÂºÄÂßãËßÑÂàí
                        </div>
                    </div>
                </div>

                <div class="jarvis-box" style="flex:1">
                    <div class="corner-br"></div>
                    <div class="box-title">RECOMMENDATIONS // Êé®Ëçê</div>
                    <div style="overflow-y:auto" id="recommendations">
                        <div style="text-align:center; color:#aaa; padding:10px;">
                            ÊöÇÊó†Êé®Ëçê
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let currentSessionId = null;
        let currentOptions = [];
        let selectedOptionIndex = null;
        let gaodeMap = null;  // È´òÂæ∑Âú∞ÂõæÂÆû‰æã
        let mapMarkers = [];  // Âú∞ÂõæÊ†áËÆ∞Êï∞ÁªÑ
        let pathPolylines = [];  // Ë∑ØÂæÑÁ∫øÊï∞ÁªÑ
        let visitHistory = [];  // ËÆøÈóÆÂéÜÂè≤

        // 0. ÂàùÂßãÂåñÈ´òÂæ∑Âú∞Âõæ
        function initGaodeMap() {
            gaodeMap = new AMap.Map('gaode-map', {
                zoom: 13,
                center: [120.5242, 31.3012],  // ËãèÂ∑ûÁ´ô
                mapStyle: 'amap://styles/dark',  // Ê∑±Ëâ≤È£éÊ†º
                viewMode: '3D'
            });
            
            addLog('È´òÂæ∑Âú∞ÂõæÂàùÂßãÂåñÊàêÂäü');
        }
        
        // Êõ¥Êñ∞Âú∞ÂõæÊ†áËÆ∞ÔºàÂçï‰∏™Ôºâ
        function updateMapMarker(location, name, isStart = false) {
            if(!gaodeMap) return;
            
            // Ê∏ÖÈô§ÊóßÊ†áËÆ∞
            mapMarkers.forEach(marker => marker.setMap(null));
            mapMarkers = [];
            
            // Ê∑ªÂä†Êñ∞Ê†áËÆ∞
            const marker = new AMap.Marker({
                position: location,
                title: name,
                label: {
                    content: name,
                    direction: 'top'
                },
                icon: isStart ? 
                    new AMap.Icon({
                        size: new AMap.Size(30, 40),
                        image: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png'
                    }) :
                    new AMap.Icon({
                        size: new AMap.Size(30, 40),
                        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png'
                    })
            });
            
            marker.setMap(gaodeMap);
            mapMarkers.push(marker);
            
            // ÁßªÂä®Âú∞Âõæ‰∏≠ÂøÉÂà∞Ê†áËÆ∞‰ΩçÁΩÆ
            gaodeMap.setCenter(location);
        }
        
        // üó∫Ô∏è Âú®Âú∞Âõæ‰∏äÊòæÁ§∫ÊâÄÊúâÂÄôÈÄâÁÇπ
        function showAllOptionsOnMap(options) {
            if(!gaodeMap) return;
            
            // Âè™Ê∏ÖÈô§ÂÄôÈÄâÊ†áËÆ∞Ôºå‰øùÁïôÂéÜÂè≤Ë∑ØÂæÑ
            const historyMarkerCount = visitHistory.length;
            mapMarkers.slice(historyMarkerCount).forEach(marker => marker.setMap(null));
            mapMarkers = mapMarkers.slice(0, historyMarkerCount);
            
            const points = [];
            
            options.forEach((opt, index) => {
                if(opt.lat && opt.lon) {
                    const marker = new AMap.Marker({
                        position: [opt.lon, opt.lat],
                        title: opt.name,
                        label: {
                            content: `${index + 1}. ${opt.name}`,
                            direction: 'right',
                            offset: new AMap.Pixel(10, 0)
                        },
                        icon: new AMap.Icon({
                            size: new AMap.Size(25, 34),
                            image: `https://webapi.amap.com/theme/v1.3/markers/n/mark_b${index + 1}.png`
                        })
                    });
                    
                    marker.setMap(gaodeMap);
                    mapMarkers.push(marker);
                    points.push([opt.lon, opt.lat]);
                }
            });
            
            // Ëá™Âä®Ë∞ÉÊï¥Âú∞ÂõæËßÜÈáé‰ª•ÊòæÁ§∫ÊâÄÊúâÁÇπ
            if(points.length > 0) {
                gaodeMap.setFitView();
                addLog(`üó∫Ô∏è Âú∞ÂõæÂ∑≤ÊòæÁ§∫ ${points.length} ‰∏™ÂÄôÈÄâÁÇπ`);
            }
        }
        
        // üõ£Ô∏è ÁªòÂà∂Ë∑ØÂæÑÁ∫øÔºà‰ªé‰∏ä‰∏Ä‰∏™Âú∞ÁÇπÂà∞ÂΩìÂâçÂú∞ÁÇπÔºâ
        function drawPathLine(fromPos, toPos, toName) {
            if(!gaodeMap) return;
            
            // ÂàõÂª∫Ë∑ØÂæÑÁ∫ø
            const polyline = new AMap.Polyline({
                path: [fromPos, toPos],
                strokeColor: '#00f3ff',
                strokeWeight: 3,
                strokeOpacity: 0.8,
                strokeStyle: 'solid',
                lineJoin: 'round'
            });
            
            polyline.setMap(gaodeMap);
            pathPolylines.push(polyline);
            
            // Ê∑ªÂä†Â∫èÂè∑Ê†áËÆ∞
            const visitNumber = visitHistory.length;
            const marker = new AMap.Marker({
                position: toPos,
                title: toName,
                label: {
                    content: `‚úÖ ${visitNumber}. ${toName}`,
                    direction: 'top'
                },
                icon: new AMap.Icon({
                    size: new AMap.Size(32, 32),
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                })
            });
            
            marker.setMap(gaodeMap);
            mapMarkers.unshift(marker);  // Ê∑ªÂä†Âà∞Êï∞ÁªÑÂºÄÂ§¥Ôºå‰øùÁïôÂéÜÂè≤Ê†áËÆ∞
            
            addLog(`üõ£Ô∏è Â∑≤ÁªòÂà∂Ë∑ØÂæÑ: ‚Üí ${toName}`);
        }
        
        // Á≠âÂæÖÈ´òÂæ∑Âú∞ÂõæAPIÂä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        if(typeof AMap !== 'undefined') {
            setTimeout(initGaodeMap, 500);
        }

        // 1. ÂàùÂßãÂåñ ECharts Èõ∑ËææÂõæ
        var radarChart = echarts.init(document.getElementById('radar-chart'));
        var radarOption = {
            radar: {
                indicator: [
                    { name: 'ÂÜ≤Á™ÅÂ∫¶', max: 100 },
                    { name: 'Êñ∞È≤úÊÑü', max: 100 },
                    { name: '‰ΩìÂäõÈúÄÊ±Ç', max: 100 },
                    { name: 'ËøûÁª≠ÊÄß', max: 100 },
                    { name: 'È£éÈô©', max: 100 }
                ],
                shape: 'circle',
                splitNumber: 4,
                axisName: { color: '#00f3ff' },
                splitLine: { lineStyle: { color: 'rgba(0, 243, 255, 0.2)' } },
                splitArea: { show: false },
                axisLine: { lineStyle: { color: 'rgba(0, 243, 255, 0.2)' } }
            },
            series: [{
                type: 'radar',
                data: [
                    {
                        value: [10, 50, 50, 50, 10],
                        name: 'Tension Analysis',
                        areaStyle: { color: 'rgba(0, 243, 255, 0.3)' },
                        lineStyle: { color: '#00f3ff' }
                    }
                ]
            }]
        };
        radarChart.setOption(radarOption);
        window.addEventListener('resize', function() { radarChart.resize(); });

        // 2. ÂÆûÊó∂Êó∂Èíü
        setInterval(() => {
            const now = new Date();
            document.getElementById('realtime-clock').innerText = now.toLocaleTimeString();
        }, 1000);

        // 3. ÁªàÁ´ØÊó•Âøó
        function addLog(message) {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = 'log-line';
            line.innerText = "> " + message;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
            
            if(terminal.children.length > 30) {
                terminal.removeChild(terminal.firstChild);
            }
        }

        // 4. ÂºÄÂßã‰ºöËØù
        async function startSession() {
            addLog("Initializing new session...");
            document.getElementById('ai-status').innerText = "INITIALIZING...";
            document.getElementById('ai-reasoning').innerText = "Ê≠£Âú®ËøûÊé•4DÁ©∫Èó¥Êô∫ËÉΩÂºïÊìé...";
            
            try {
                const response = await fetch('/api/session/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        city: 'ËãèÂ∑û',
                        start_location: 'ËãèÂ∑ûÁ´ô',
                        duration_days: 3,
                        budget: 5000,
                        preferences: ['ÊôØÁÇπ', 'ÁæéÈ£ü']
                    })
                });
                
                const data = await response.json();
                
                if(data.success) {
                    currentSessionId = data.session_id;
                    addLog(`Session created: ${data.session_id}`);
                    addLog(`Starting location: ${data.state.location}`);
                    
                    // üó∫Ô∏è ÊòæÁ§∫Ëµ∑ÁÇπÊ†áËÆ∞
                    updateMapMarker([120.5242, 31.3012], data.state.location, true);
                    
                    // üìç ÂàùÂßãÂåñËÆøÈóÆÂéÜÂè≤ÔºàËµ∑ÁÇπÔºâ
                    visitHistory = [{
                        name: data.state.location,
                        lat: 31.3012,
                        lon: 120.5242,
                        time: 0,
                        budget: data.state.budget
                    }];
                    
                    document.getElementById('dest-city').innerText = 'ËãèÂ∑û';
                    document.getElementById('budget-left').innerText = data.state.budget;
                    document.getElementById('ai-status').innerText = "‚û°Ô∏è NEXT STEP";
                    document.getElementById('ai-reasoning').innerText = "üëâ ÁÇπÂáª GET OPTIONS ÊåâÈíÆËé∑ÂèñAIÊé®Ëçê";
                    
                    document.getElementById('btn-next').disabled = false;
                } else {
                    addLog(`ERROR: ${data.error}`);
                }
            } catch(error) {
                addLog(`ERROR: ${error.message}`);
            }
        }

        // 5. Ëé∑Âèñ‰∏ã‰∏ÄÊ≠•ÈÄâÈ°π
        async function getNextOptions() {
            if(!currentSessionId) {
                addLog("ERROR: No active session");
                return;
            }
            
            addLog("Requesting next options from W-Axis...");
            document.getElementById('ai-status').innerText = "ANALYZING...";
            document.getElementById('ai-reasoning').innerText = "WËΩ¥Êé®ÁêÜ‰∏≠...ËÆ°ÁÆóÂº†ÂäõÂíåÂÜ≤Á™ÅÂ∫¶...";
            
            try {
                const response = await fetch('/api/plan/next', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        k: 5
                    })
                });
                
                const data = await response.json();
                
                if(data.success && data.options.length > 0) {
                    currentOptions = data.options;
                    addLog(`Received ${data.options.length} options`);
                    
                    // üó∫Ô∏è Âú®Âú∞Âõæ‰∏äÊòæÁ§∫ÊâÄÊúâÂÄôÈÄâÁÇπ
                    showAllOptionsOnMap(data.options);
                    
                    // Êõ¥Êñ∞Êó∂Èó¥ËΩ¥
                    renderTimeline(data.options);
                    
                    // ÈªòËÆ§ÈÄâ‰∏≠Á¨¨‰∏Ä‰∏™
                    selectTimelineItem(0);
                    
                    // Êõ¥Êñ∞Êé®ËçêÂç°Áâá
                    renderRecommendations(data.options.slice(0, 3));
                    
                    document.getElementById('btn-select').disabled = false;
                    
                    // Êõ¥Êñ∞È¢ÑÁÆóÊòæÁ§∫
                    if(data.session_state) {
                        document.getElementById('budget-left').innerText = data.session_state.budget_left;
                    }
                    
                    // üí° UIÊèêÁ§∫
                    document.getElementById('ai-status').innerText = "üí° PLEASE SELECT";
                    document.getElementById('ai-reasoning').innerText = 
                        "üëÜ ÁÇπÂáªÊó∂Èó¥ËΩ¥ÊàñÊé®ËçêÂç°ÁâáÊü•ÁúãËØ¶ÊÉÖÔºåÁÑ∂ÂêéÁÇπÂáª ‚úÖ CONFIRM Á°ÆËÆ§ÂâçÂæÄ";
                } else {
                    addLog("No more options available");
                    document.getElementById('ai-status').innerText = "MISSION COMPLETE";
                }
            } catch(error) {
                addLog(`ERROR: ${error.message}`);
            }
        }

        // 6. Ê∏≤ÊüìÊó∂Èó¥ËΩ¥
        function renderTimeline(options) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            options.forEach((opt, index) => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.onclick = () => selectTimelineItem(index);
                
                // ÁîüÊàêemoji
                const emoji = opt.type === 'attraction' ? 'üèõÔ∏è' : 
                             opt.type === 'restaurant' ? 'üçΩÔ∏è' : 'üìç';
                
                // ËÆøÈóÆÊ¨°Êï∞ÂæΩÁ´†
                const visitBadge = opt.visit_count > 0 ? 
                    `<span style="color:#ff0; font-size:0.7rem">(üîÑ Á¨¨${opt.visit_count+1}Ê¨°)</span>` : 
                    `<span style="color:#0f0; font-size:0.7rem">(‚ú® Êñ∞)</span>`;
                
                item.innerHTML = `
                    <div class="time">#${index + 1}</div>
                    <div>
                        <div class="event">${emoji} ${opt.name} ${visitBadge}</div>
                        <div class="event-detail">üìç ${opt.region} | ${opt.travel ? opt.travel.mode + ' ' + opt.travel.time + 'ÂàÜÈíü' : 'Êú™Áü•'}</div>
                        <div class="event-score">‚≠ê ${opt.score} | üåå WËΩ¥: ${opt.w_axis} | ‚öîÔ∏è ÂÜ≤Á™Å: ${opt.tensions.conflict}</div>
                        <div class="event-detail" style="color:#0ff; margin-top:5px">üí≠ ${opt.explanation}</div>
                    </div>
                `;
                timeline.appendChild(item);
            });
        }

        // 7. ÈÄâÊã©Êó∂Èó¥ËΩ¥È°π
        function selectTimelineItem(index) {
            selectedOptionIndex = index;
            
            // Êõ¥Êñ∞UIÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.timeline-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });
            
            const opt = currentOptions[index];
            
            // Êõ¥Êñ∞AIËß£ÈáäÔºàÊòæÁ§∫ÂΩìÂâçÈÄâÊã©Ôºâ
            document.getElementById('ai-status').innerText = `üéØ SELECTED #${index + 1}`;
            document.getElementById('ai-reasoning').innerText = opt.explanation;
            
            // Êõ¥Êñ∞Èõ∑ËææÂõæ
            updateRadar(opt);
            
            // üó∫Ô∏è Âú∞ÂõæËÅöÁÑ¶Âà∞ÈÄâ‰∏≠ÁöÑÁÇπ
            if(opt.lat && opt.lon && gaodeMap) {
                gaodeMap.setZoomAndCenter(15, [opt.lon, opt.lat]);
            }
            
            addLog(`‚úÖ Selected: #${index + 1} ${opt.name}`);
        }

        // 8. Êõ¥Êñ∞Èõ∑ËææÂõæ
        function updateRadar(option) {
            const t = option.tensions;
            radarOption.series[0].data[0].value = [
                Math.abs(t.conflict * 100),
                Math.max(0, t.novelty * 100),
                Math.max(0, -t.energy * 100 + 50),
                Math.max(0, t.continuity * 100),
                option.risk.level === 'warning' ? 70 : 10
            ];
            radarChart.setOption(radarOption);
            
            // Êõ¥Êñ∞È£éÈô©Á∫ßÂà´
            document.getElementById('risk-level').innerText = 
                option.risk.level === 'warning' ? 'HIGH' : 'LOW';
        }

        // 9. Ê∏≤ÊüìÊé®ËçêÂç°Áâá
        function renderRecommendations(options) {
            const container = document.getElementById('recommendations');
            container.innerHTML = '';
            
            options.forEach((opt, index) => {
                const emoji = opt.type === 'attraction' ? 'üèõÔ∏è' : 
                             opt.type === 'restaurant' ? 'üçΩÔ∏è' : 'üìç';
                
                const card = document.createElement('div');
                card.className = 'resource-card';
                card.style.cursor = 'pointer';
                card.innerHTML = `
                    <div class="card-img">${emoji}</div>
                    <div>
                        <div>${opt.name}</div>
                        <div style="font-size:0.8rem; color:#aaa">${opt.region} | ‚≠ê${opt.score}</div>
                    </div>
                `;
                
                // üî• Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºöÈÄâÊã©ËØ•ÈÄâÈ°π
                card.onclick = () => {
                    selectTimelineItem(opt.rank - 1);  // rank‰ªé1ÂºÄÂßãÔºåindex‰ªé0ÂºÄÂßã
                    addLog(`üëÜ Selected from recommendations: ${opt.name}`);
                    // ËßÜËßâÂèçÈ¶à
                    card.style.border = '2px solid #00f3ff';
                    setTimeout(() => card.style.border = '1px solid rgba(0, 243, 255, 0.3)', 500);
                };
                
                container.appendChild(card);
            });
        }

        // 10. Á°ÆËÆ§ÈÄâÊã©
        async function selectOption() {
            if(selectedOptionIndex === null) {
                addLog("WARNING: No option selected, using first option");
                selectedOptionIndex = 0;
            }
            
            const opt = currentOptions[selectedOptionIndex];
            addLog(`Confirming selection: ${opt.name}`);
            document.getElementById('ai-status').innerText = "EXECUTING...";
            
            try {
                const response = await fetch('/api/plan/select', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        option_index: selectedOptionIndex
                    })
                });
                
                const data = await response.json();
                
                if(data.success) {
                    // üéâ ÊàêÂäüÂèçÈ¶à
                    document.getElementById('ai-status').innerText = "‚úÖ SUCCESS!";
                    document.getElementById('ai-reasoning').innerText = `Â∑≤ÂâçÂæÄ ${opt.name}ÔºÅ`;
                    
                    addLog(`‚úÖ Traveled to: ${data.new_state.location}`);
                    addLog(`‚è∞ Time: ${Math.round(data.new_state.time * 10) / 10}h | üí∞ Budget: ¬•${Math.round(data.new_state.budget)}`);
                    
                    // üõ£Ô∏è ÁªòÂà∂Ë∑ØÂæÑÁ∫ø
                    if(opt.lat && opt.lon && visitHistory.length > 0) {
                        const lastVisit = visitHistory[visitHistory.length - 1];
                        drawPathLine([lastVisit.lon, lastVisit.lat], [opt.lon, opt.lat], opt.name);
                    }
                    
                    // üìç ËÆ∞ÂΩïËÆøÈóÆÂéÜÂè≤
                    visitHistory.push({
                        name: opt.name,
                        lat: opt.lat,
                        lon: opt.lon,
                        time: data.new_state.time,
                        budget: data.new_state.budget
                    });
                    
                    addLog(`üìù ËÆøÈóÆÂéÜÂè≤: ${visitHistory.length} ‰∏™Âú∞ÁÇπ`);
                    
                    // ÈáçÁΩÆÈÄâÊã©
                    selectedOptionIndex = null;
                    currentOptions = [];
                    
                    // ‚è±Ô∏è ÊòæÁ§∫ÂÄíËÆ°Êó∂ÊèêÁ§∫
                    let countdown = 2;
                    const countdownInterval = setInterval(() => {
                        document.getElementById('ai-reasoning').innerText = 
                            `Ê≠£Âú®Ëé∑Âèñ‰∏ã‰∏ÄÊ≠•Êé®Ëçê... ${countdown}Áßí`;
                        countdown--;
                        if(countdown < 0) clearInterval(countdownInterval);
                    }, 1000);
                    
                    // Ëá™Âä®Ëé∑Âèñ‰∏ã‰∏ÄÊ≠•
                    setTimeout(() => getNextOptions(), 2000);
                } else {
                    addLog(`ERROR: ${data.error}`);
                }
            } catch(error) {
                addLog(`ERROR: ${error.message}`);
            }
        }

        // ÂàùÂßãÂåñÊó•Âøó
        addLog("JARVIS Travel Agent v3.0 initialized");
        addLog("4D Spatial Intelligence Engine ready");
        addLog("Click START MISSION to begin");

    </script>
</body>
</html>
