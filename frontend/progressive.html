<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Horizon | æ¸è¿›å¼æ‹“æ‰‘è§„åˆ’ [æ ¸å¿ƒç‰ˆ]</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=c0879532b66de630ce0e0937e828fa12"></script>
    
    <style>
        * { box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0; 
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0; padding: 0; overflow: hidden;
        }
        
        .neon-text { 
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 40px rgba(59, 130, 246, 0.4); 
        }
        
        .glass-panel { 
            background: rgba(30, 41, 59, 0.85); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            border-radius: 4px; 
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeInUp 0.4s ease-out; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }
        .pulse-glow { animation: pulse 2s ease-in-out infinite; }
        
        @keyframes expandNode {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .badge-green { background: rgba(16, 185, 129, 0.3); color: #10b981; border: 1px solid #10b981; }
        .badge-yellow { background: rgba(251, 191, 36, 0.3); color: #fbbf24; border: 1px solid #fbbf24; }
        .badge-red { background: rgba(239, 68, 68, 0.3); color: #ef4444; border: 1px solid #ef4444; }
        .badge-blue { background: rgba(59, 130, 246, 0.3); color: #3b82f6; border: 1px solid #3b82f6; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>
    <div id="app" class="h-screen flex flex-col">
        
        <!-- åŠ è½½é®ç½© -->
        <div v-if="loading" class="loading-overlay animate-fade-in">
            <div class="glass-panel p-8 rounded-2xl text-center">
                <div class="w-16 h-16 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <div class="text-xl font-bold text-cyan-300">{{ loadingMessage }}</div>
            </div>
        </div>
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <header class="h-20 border-b border-slate-700 flex items-center justify-between px-8 bg-slate-900/90 backdrop-blur-sm">
            <div class="flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-green-500 pulse-glow"></div>
                <h1 class="text-2xl font-bold tracking-wider neon-text">
                    EVENT HORIZON
                    <span class="text-sm font-normal text-slate-400 ml-3">æ¸è¿›å¼æ‹“æ‰‘è§„åˆ’å¼•æ“</span>
                </h1>
            </div>
            
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-300">ä¼šè¯çŠ¶æ€</span>
                    <span class="badge badge-green" v-if="sessionId">â— {{ sessionId.substring(0,8) }}</span>
                    <span class="badge badge-yellow" v-else>æœªå¼€å§‹</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-300">å½“å‰è·¯å¾„</span>
                    <span class="badge badge-blue">{{ currentPath.length }} ä¸ªåœ°ç‚¹</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-300">å±•å¼€å±‚çº§</span>
                    <span class="text-lg font-mono text-cyan-400 font-bold">Level {{ currentLevel }}</span>
                </div>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden">
            
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <aside class="w-96 border-r border-slate-700 p-6 flex flex-col gap-6 bg-slate-900/50 overflow-y-auto">
                
                <!-- ä¼šè¯åˆå§‹åŒ– -->
                <div v-if="!sessionId" class="space-y-5 animate-fade-in">
                    <h3 class="text-base font-bold text-cyan-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="text-2xl">ğŸš€</span>
                        <span>å¼€å§‹æ–°æ—…ç¨‹</span>
                    </h3>
                    
                    <div class="glass-panel p-5 rounded-xl space-y-5">
                        <div>
                            <label class="text-sm text-slate-300 block mb-3 font-medium">ğŸ’¬ å‘Šè¯‰æˆ‘ä½ çš„éœ€æ±‚</label>
                            <textarea v-model="userInput" rows="3" class="w-full bg-slate-800 border-2 border-slate-600 rounded-lg px-4 py-3 text-base text-slate-200 focus:outline-none focus:border-blue-500 transition" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³åœ¨è‹å·ç©1å¤©ï¼Œå–œæ¬¢æ–‡åŒ–å’Œå›­æ—"></textarea>
                        </div>
                        
                        <div>
                            <label class="text-sm text-slate-300 block mb-3 font-medium">ğŸ“ å‡ºå‘åœ°ç‚¹</label>
                            <input v-model="startLocation" type="text" class="w-full bg-slate-800 border-2 border-slate-600 rounded-lg px-4 py-3 text-base text-slate-200 focus:outline-none focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="text-sm text-slate-300 block mb-3 font-medium">ğŸŒ ç›®çš„åœ°åŸå¸‚</label>
                            <select v-model="city" class="w-full bg-slate-800 border-2 border-slate-600 rounded-lg px-4 py-3 text-base text-slate-200 focus:outline-none focus:border-blue-500">
                                <option value="è‹å·">è‹å·</option>
                                <option value="æ­å·">æ­å·</option>
                                <option value="å—äº¬">å—äº¬</option>
                            </select>
                        </div>
                        
                        <button @click="startNewSession" class="w-full glass-panel p-4 rounded-xl text-lg font-bold text-cyan-400 hover:bg-slate-700 transition flex items-center justify-center gap-3 pulse-glow">
                            <span>ğŸ¯</span>
                            <span>å¼€å§‹è§„åˆ’</span>
                        </button>
                    </div>
                </div>
                
                <!-- ä¼šè¯è¿›è¡Œä¸­ -->
                <div v-else class="space-y-5 animate-fade-in">
                    <h3 class="text-base font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="text-2xl">ğŸ—ºï¸</span>
                        <span>å½“å‰è·¯å¾„</span>
                    </h3>
                    
                    <div class="glass-panel p-5 rounded-xl space-y-3">
                        <div v-for="(poi, idx) in currentPath" :key="idx" class="flex items-center gap-3 p-3 rounded-lg bg-slate-800/50 border border-slate-700">
                            <span class="text-2xl">{{ idx === 0 ? 'ğŸš©' : 'ğŸ“' }}</span>
                            <div class="flex-1">
                                <div class="font-bold text-slate-200">{{ idx + 1 }}. {{ poi }}</div>
                                <div class="text-xs text-slate-400">{{ idx === 0 ? 'å‡ºå‘ç‚¹' : `ç¬¬${idx}ç«™` }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç´¯è®¡ç»Ÿè®¡ -->
                    <div class="glass-panel p-5 rounded-xl space-y-3">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">ğŸ“Š ç´¯è®¡ç»Ÿè®¡</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-slate-800/70 p-3 rounded-lg">
                                <div class="text-slate-400 mb-1">ç´¯è®¡è·ç¦»</div>
                                <div class="font-mono font-bold text-green-400 text-xl">{{ totalDistance.toFixed(1) }} km</div>
                            </div>
                            <div class="bg-slate-800/70 p-3 rounded-lg">
                                <div class="text-slate-400 mb-1">ç´¯è®¡æ—¶é—´</div>
                                <div class="font-mono font-bold text-blue-400 text-xl">{{ totalTime.toFixed(0) }} åˆ†</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="space-y-3">
                        <button @click="resetSession" class="w-full glass-panel p-3 rounded-xl text-base font-bold text-yellow-400 hover:bg-slate-700 transition flex items-center justify-center gap-2">
                            <span>ğŸ”„</span>
                            <span>é‡æ–°å¼€å§‹</span>
                        </button>
                        
                        <button @click="finishJourney" class="w-full glass-panel p-3 rounded-xl text-base font-bold text-green-400 hover:bg-slate-700 transition flex items-center justify-center gap-2">
                            <span>âœ…</span>
                            <span>å®Œæˆæ—…ç¨‹</span>
                        </button>
                    </div>
                </div>
                
                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="glass-panel p-4 rounded-lg text-xs text-slate-400 space-y-2 mt-auto">
                    <h4 class="font-bold text-slate-300 text-sm mb-2">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
                    <ul class="space-y-1 list-disc list-inside">
                        <li>ç‚¹å‡»<strong>èµ·ç‚¹</strong>â†’è‡ªåŠ¨å±•å¼€æ¨è</li>
                        <li>ç‚¹å‡»<strong>ä»»æ„èŠ‚ç‚¹</strong>â†’è‡ªåŠ¨å±•å¼€ä¸‹ä¸€å±‚</li>
                        <li>è“è‰²èŠ‚ç‚¹ = å·²é€‰æ‹©</li>
                        <li>ç»¿/é»„/çº¢è‰² = æ¨èç­‰çº§</li>
                        <li>é€æ­¥æ„å»ºå®Œæ•´è·¯å¾„</li>
                    </ul>
                </div>
            </aside>

            <!-- ä¸­é—´ç”»å¸ƒï¼šæ‹“æ‰‘å›¾ + åœ°å›¾ -->
            <section class="flex-1 relative flex">
                <!-- å·¦ä¾§ï¼šæ‹“æ‰‘å›¾ -->
                <div class="w-1/2 relative bg-gradient-to-br from-slate-950 to-slate-900 border-r border-slate-700">
                    <div class="absolute inset-0 opacity-10" style="background-image: repeating-linear-gradient(0deg, #3b82f6 0px, transparent 1px, transparent 50px), repeating-linear-gradient(90deg, #3b82f6 0px, transparent 1px, transparent 50px);"></div>
                    <div id="graph-container" class="w-full h-full relative z-10"></div>
                    
                    <!-- æ‹“æ‰‘å›¾æ ‡ç­¾ -->
                    <div class="absolute top-4 left-4 glass-panel px-4 py-2 rounded-lg">
                        <span class="text-sm font-bold text-cyan-400">ğŸ”· æ‹“æ‰‘å…³ç³»å›¾</span>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šé«˜å¾·åœ°å›¾ -->
                <div class="w-1/2 relative bg-slate-900">
                    <div id="map-container" class="w-full h-full"></div>
                    
                    <!-- åœ°å›¾æ ‡ç­¾ -->
                    <div class="absolute top-4 left-4 glass-panel px-4 py-2 rounded-lg z-10">
                        <span class="text-sm font-bold text-green-400">ğŸ—ºï¸ åœ°ç†ä½ç½®</span>
                    </div>
                </div>
                
                <!-- AIæç¤º -->
                <transition>
                    <div v-if="aiMessage" class="absolute bottom-10 left-1/2 -translate-x-1/2 glass-panel px-8 py-4 rounded-full flex items-center gap-4 shadow-2xl animate-fade-in">
                        <span class="text-3xl">{{ aiMessageIcon }}</span>
                        <span class="text-base font-medium text-cyan-300">{{ aiMessage }}</span>
                    </div>
                </transition>
                
                <!-- å›¾ä¾‹ -->
                <div class="absolute top-8 right-8 glass-panel p-5 rounded-xl text-sm space-y-3">
                    <h4 class="font-bold text-slate-200 mb-4">ğŸ¨ èŠ‚ç‚¹çŠ¶æ€</h4>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                        <span class="text-slate-300">å·²é€‰æ‹©</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                        <span class="text-slate-300">å¼ºçƒˆæ¨è</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                        <span class="text-slate-300">æ¨è</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                        <span class="text-slate-300">ä¸æ¨è</span>
                    </div>
                </div>
                
                <!-- èŠ‚ç‚¹è®¡æ•° -->
                <div class="absolute top-8 left-8 glass-panel px-6 py-4 rounded-xl">
                    <div class="text-xs text-slate-400 mb-1">å½“å‰èŠ‚ç‚¹æ•°</div>
                    <div class="text-4xl font-bold font-mono text-blue-400">{{ graphNodes.length }}</div>
                </div>
                
                <!-- æç¤ºæ–‡å­— -->
                <div v-if="!sessionId" class="absolute inset-0 flex items-center justify-center">
                    <div class="text-center animate-fade-in">
                        <div class="text-8xl mb-6 opacity-30">ğŸ—ºï¸</div>
                        <p class="text-2xl font-bold text-slate-400 mb-2">æ¸è¿›å¼æ‹“æ‰‘è§„åˆ’</p>
                        <p class="text-lg text-slate-500">ç‚¹å‡»å·¦ä¾§"å¼€å§‹è§„åˆ’"åˆ›å»ºæ—…ç¨‹</p>
                    </div>
                </div>
            </section>

            <!-- å³ä¾§è¯¦æƒ…é¢æ¿ -->
            <aside class="w-[450px] border-l border-slate-700 p-6 bg-slate-900/50 overflow-y-auto">
                <div v-if="selectedNode" class="space-y-6 animate-fade-in">
                    
                    <div class="glass-panel rounded-xl overflow-hidden">
                        <div class="h-36 bg-gradient-to-br from-blue-900 via-blue-800 to-slate-900 flex items-center justify-center relative">
                            <div class="absolute inset-0 bg-black opacity-30"></div>
                            <div class="text-center z-10">
                                <h2 class="text-3xl font-bold text-white mb-3">{{ selectedNode.name }}</h2>
                                <div class="flex gap-2 justify-center flex-wrap">
                                    <span class="badge badge-blue text-sm" v-for="tag in selectedNode.tags">{{ tag }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¯„åˆ†å¡ç‰‡ -->
                    <div class="glass-panel p-6 rounded-xl">
                        <div class="flex items-end justify-between border-b-2 border-slate-700 pb-5 mb-5">
                            <div>
                                <div class="text-sm text-slate-400 mb-2">ç»¼åˆæ¨èæŒ‡æ•°</div>
                                <div class="text-6xl font-bold font-mono" :class="scoreColor(selectedNode.final_score)">
                                    {{ selectedNode.final_score.toFixed(2) }}
                                </div>
                                <div class="text-sm text-slate-400 mt-1">æ’å #{{ selectedNode.rank }}</div>
                            </div>
                        </div>
                        
                        <div class="space-y-3 text-base">
                            <div class="flex justify-between">
                                <span class="text-slate-300">åŸºç¡€è¯„åˆ†</span>
                                <span class="font-mono text-slate-100 font-bold">{{ selectedNode.base_score.toFixed(2) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-300">å¤©æ°”ä¿®æ­£</span>
                                <span class="font-mono font-bold" :class="selectedNode.weather_modifier > 1 ? 'text-green-400' : selectedNode.weather_modifier < 1 ? 'text-red-400' : 'text-slate-200'">
                                    {{ selectedNode.weather_modifier.toFixed(2) }}x
                                    {{ selectedNode.weather_modifier > 1 ? 'â¬†ï¸' : selectedNode.weather_modifier < 1 ? 'â¬‡ï¸' : 'â¡ï¸' }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-300">æ—¶ç©ºé˜»å°¼</span>
                                <span class="font-mono font-bold" :class="selectedNode.damping_modifier >= 1 ? 'text-green-400' : selectedNode.damping_modifier >= 0.6 ? 'text-yellow-400' : 'text-red-400'">
                                    {{ selectedNode.damping_modifier.toFixed(2) }}x
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- è·¯çº¿ä¿¡æ¯ï¼ˆé«˜å¾·APIï¼‰-->
                    <div v-if="selectedNode.route_info" class="glass-panel p-5 rounded-xl">
                        <h4 class="text-base font-bold text-slate-200 flex items-center gap-2 mb-4">
                            <span class="text-2xl">ğŸš¶</span>
                            <span>è·¯çº¿ä¿¡æ¯ (é«˜å¾·API)</span>
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-800/70 p-3 rounded-lg">
                                <div class="text-slate-400 text-xs mb-1">è·ç¦»</div>
                                <div class="font-mono font-bold text-green-400 text-lg">{{ selectedNode.distance_from_prev }} km</div>
                            </div>
                            <div class="bg-slate-800/70 p-3 rounded-lg">
                                <div class="text-slate-400 text-xs mb-1">æ­¥è¡Œæ—¶é—´</div>
                                <div class="font-mono font-bold text-blue-400 text-lg">{{ selectedNode.time_from_prev }} åˆ†</div>
                            </div>
                        </div>
                    </div>

                    <!-- AIæ¨èç†ç”± -->
                    <div class="glass-panel p-5 rounded-xl">
                        <h4 class="text-base font-bold text-slate-200 flex items-center gap-2 mb-3">
                            <span class="text-2xl">ğŸ§ </span>
                            <span>AI æ¨èç†ç”±</span>
                        </h4>
                        <div class="p-4 rounded-lg bg-slate-800/70 border-2 border-slate-700 text-base leading-relaxed text-slate-200">
                            {{ selectedNode.reason }}
                        </div>
                    </div>

                    <!-- æ‹¥å µè­¦å‘Š -->
                    <div v-if="selectedNode.is_blocked" class="glass-panel p-5 rounded-xl bg-red-900/30 border-2 border-red-500/70 pulse-glow">
                        <div class="flex gap-4 items-start">
                            <span class="text-3xl">â›”</span>
                            <div>
                                <h5 class="font-bold text-red-400 text-base uppercase mb-3">æ‹¥å µç†”æ–­è­¦å‘Š</h5>
                                <p class="text-base text-red-200">{{ selectedNode.block_reason }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- çŠ¶æ€æç¤º -->
                    <div v-if="!selectedNode.is_selected && !selectedNode.is_blocked" class="glass-panel p-4 rounded-xl bg-gradient-to-r from-green-900/20 to-blue-900/20 border border-green-500/30">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âœ¨</span>
                            <div>
                                <p class="font-bold text-green-400 text-lg mb-1">ç‚¹å‡»åè‡ªåŠ¨å±•å¼€</p>
                                <p class="text-sm text-slate-400">ç³»ç»Ÿå°†æ™ºèƒ½æ¨èä¸‹ä¸€æ­¥å€™é€‰åœ°ç‚¹</p>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="selectedNode.is_selected" class="glass-panel p-4 rounded-xl bg-gradient-to-r from-blue-900/20 to-purple-900/20 border border-blue-500/30">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âœ…</span>
                            <div>
                                <p class="font-bold text-blue-400 text-lg mb-1">å·²é€‰æ‹©</p>
                                <p class="text-sm text-slate-400">æ­¤åœ°ç‚¹å·²åŠ å…¥æ—…ç¨‹è·¯å¾„</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-else class="h-full flex flex-col items-center justify-center text-slate-600 space-y-6">
                    <div class="text-8xl opacity-30">ğŸ“</div>
                    <div class="text-center">
                        <p class="font-medium text-slate-400 text-lg mb-2">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</p>
                        <p class="text-base text-slate-500">é€‰æ‹©åœ°ç‚¹åå±•å¼€ä¸‹ä¸€æ­¥</p>
                    </div>
                </div>
            </aside>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // çŠ¶æ€
                const sessionId = ref(null);
                const userInput = ref('æˆ‘æƒ³åœ¨è‹å·ç©1å¤©ï¼Œå–œæ¬¢æ–‡åŒ–å’Œå›­æ—');
                const startLocation = ref('è‹å·ç«™');
                const city = ref('è‹å·');
                const currentPath = ref([]);
                const currentLevel = ref(0);
                const loading = ref(false);
                const loadingMessage = ref('');
                const aiMessage = ref('');
                const aiMessageIcon = ref('ğŸ¤–');
                
                const graphNodes = ref([]);
                const graphLinks = ref([]);
                const selectedNode = ref(null);
                
                const totalDistance = ref(0);
                const totalTime = ref(0);
                
                let chart = null;
                let amap = null;  // é«˜å¾·åœ°å›¾å®ä¾‹
                let mapMarkers = {};  // åœ°å›¾æ ‡è®°ç‚¹
                let mapPolyline = null;  // è·¯å¾„çº¿
                
                // å·¥å…·å‡½æ•°
                const scoreColor = (score) => {
                    return score >= 0.8 ? 'text-green-400' :
                           score >= 0.6 ? 'text-yellow-400' :
                           'text-red-400';
                };
                
                const showMessage = (icon, msg, duration = 3000) => {
                    aiMessageIcon.value = icon;
                    aiMessage.value = msg;
                    setTimeout(() => { aiMessage.value = ''; }, duration);
                };
                
                // åˆå§‹åŒ–å›¾è¡¨
                const initChart = () => {
                    chart = echarts.init(document.getElementById('graph-container'));
                    updateChart();
                    
                    chart.on('click', (params) => {
                        if (params.dataType === 'node') {
                            // ä»åŸå§‹æ•°æ®ä¸­æ¢å¤å®Œæ•´èŠ‚ç‚¹ä¿¡æ¯
                            const fullNodeData = params.data._raw || graphNodes.value.find(n => n.id === params.data.id);
                            
                            if (!fullNodeData) {
                                console.error('æ— æ³•æ‰¾åˆ°èŠ‚ç‚¹æ•°æ®:', params.data.id);
                                return;
                            }
                            
                            console.log('ç‚¹å‡»èŠ‚ç‚¹:', fullNodeData.name, 'çŠ¶æ€:', fullNodeData.is_selected);
                            
                            // æ›´æ–°å³ä¾§è¯¦æƒ…é¢æ¿
                            selectedNode.value = fullNodeData;
                            
                            // æ£€æŸ¥æ˜¯å¦è¢«æ‹¥å µç†”æ–­
                            if (fullNodeData.is_blocked) {
                                showMessage('â›”', `${fullNodeData.name} å½“å‰æ‹¥å µï¼Œä¸å»ºè®®å‰å¾€`, 3000);
                                return;
                            }
                            
                            // å›æº¯é€»è¾‘ï¼šå¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰èŠ‚ç‚¹ï¼Œåªæ˜¾ç¤ºè¯¦æƒ…ï¼Œä¸å±•å¼€
                            if (fullNodeData.is_selected || fullNodeData.id === 'start') {
                                console.log('â†’ å·²é€‰èŠ‚ç‚¹ï¼Œä»…æ˜¾ç¤ºè¯¦æƒ…');
                                showMessage('â„¹ï¸', `æŸ¥çœ‹ ${fullNodeData.name} è¯¦æƒ…ï¼ˆå·²åœ¨è·¯å¾„ä¸­ï¼‰`, 2000);
                                return;
                            }
                            
                            // åªæœ‰æœªé€‰æ‹©çš„å€™é€‰èŠ‚ç‚¹æ‰å±•å¼€
                            console.log('â†’ è‡ªåŠ¨å±•å¼€èŠ‚ç‚¹:', fullNodeData.name);
                            expandNode(fullNodeData);
                        }
                    });
                };
                
                // æ›´æ–°å›¾è¡¨ï¼ˆæ ‘çŠ¶å¸ƒå±€+è·¯å¾„é«˜äº®ï¼‰
                const updateChart = () => {
                    if (!chart || graphNodes.value.length === 0) {
                        console.log('è·³è¿‡å›¾è¡¨æ›´æ–°ï¼šchartæœªåˆå§‹åŒ–æˆ–æ— èŠ‚ç‚¹');
                        return;
                    }
                    
                    try {
                        console.log('å‡†å¤‡æ›´æ–°å›¾è¡¨ï¼ŒèŠ‚ç‚¹æ•°:', graphNodes.value.length, 'è¾¹æ•°:', graphLinks.value.length);
                        
                        // è·å–å½“å‰è·¯å¾„ä¸­çš„èŠ‚ç‚¹IDï¼ˆç”¨äºé«˜äº®ï¼‰
                        const pathNodeNames = new Set(currentPath.value);
                        
                        // å‡†å¤‡èŠ‚ç‚¹æ•°æ®
                        const nodes = graphNodes.value.map(n => {
                            const isInPath = pathNodeNames.has(n.name) || n.is_selected;
                            return {
                                id: n.id,
                                name: n.name,
                                x: n.x,
                                y: n.y,
                                symbolSize: isInPath ? 70 : (n.symbolSize || 50),
                                itemStyle: {
                                    color: isInPath ? '#3b82f6' : (n.itemStyle?.color || '#10b981'),
                                    borderColor: isInPath ? '#60a5fa' : 'transparent',
                                    borderWidth: isInPath ? 3 : 0
                                },
                                label: {
                                    show: true,
                                    position: 'bottom',
                                    color: isInPath ? '#fff' : '#e2e8f0',
                                    fontWeight: isInPath ? 'bold' : 'normal',
                                    fontSize: isInPath ? 14 : 12
                                },
                                // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºç‚¹å‡»äº‹ä»¶
                                _raw: n
                            };
                        });
                        
                        // å‡†å¤‡è¾¹æ•°æ®ï¼Œé«˜äº®è·¯å¾„ä¸­çš„è¾¹
                        const links = graphLinks.value.map(l => {
                            // æ£€æŸ¥è¿™æ¡è¾¹æ˜¯å¦åœ¨å½“å‰è·¯å¾„ä¸­
                            const sourceNode = graphNodes.value.find(n => n.id === l.source);
                            const targetNode = graphNodes.value.find(n => n.id === l.target);
                            const isInPath = sourceNode && targetNode && 
                                           sourceNode.is_selected && targetNode.is_selected;
                            
                            return {
                                source: l.source,
                                target: l.target,
                                lineStyle: {
                                    width: isInPath ? 6 : (l.lineStyle?.width || 2),
                                    color: isInPath ? '#3b82f6' : (l.lineStyle?.color || '#10b981'),
                                    opacity: isInPath ? 1 : 0.4,
                                    type: l.lineStyle?.type || 'solid'
                                },
                                label: {
                                    show: true,
                                    formatter: `${l.distance?.toFixed(1) || '?'} km`,
                                    fontSize: 10,
                                    color: '#94a3b8'
                                }
                            };
                        });
                        
                        console.log('æ•°æ®å‡†å¤‡å®Œæˆï¼ŒèŠ‚ç‚¹æ ·æœ¬:', nodes[0]);
                        console.log('è¾¹æ ·æœ¬:', links[0]);
                        
                        // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ‰€æœ‰è¾¹çš„sourceå’Œtargetéƒ½åœ¨nodesä¸­
                        const nodeIdSet = new Set(nodes.map(n => n.id));
                        const finalValidLinks = links.filter(link => {
                            const valid = nodeIdSet.has(link.source) && nodeIdSet.has(link.target);
                            if (!valid) {
                                console.error(`âŒ å›¾è¡¨æ¸²æŸ“å‰å‘ç°æ— æ•ˆè¾¹: ${link.source} -> ${link.target}`);
                            }
                            return valid;
                        });
                        
                        if (finalValidLinks.length < links.length) {
                            console.warn(`âš ï¸ è¿‡æ»¤äº† ${links.length - finalValidLinks.length} æ¡æ— æ•ˆè¾¹`);
                        }
                        
                        console.log(`æœ€ç»ˆæ•°æ®: ${nodes.length}ä¸ªèŠ‚ç‚¹, ${finalValidLinks.length}æ¡è¾¹`);
                        
                        const option = {
                            tooltip: { show: false },
                            animation: false,  // ç¦ç”¨åŠ¨ç”»æå‡æ€§èƒ½
                            series: [{
                                type: 'graph',
                                layout: 'none',
                                roam: true,
                                label: {
                                    show: true,
                                    position: 'bottom',
                                    fontSize: 12,
                                    color: '#e2e8f0',
                                    fontWeight: 'bold'
                                },
                                data: nodes,
                                links: finalValidLinks,
                                lineStyle: {
                                    opacity: 0.9,
                                    curveness: 0.2,
                                    width: 2
                                },
                                emphasis: {
                                    focus: 'adjacency',
                                    label: { fontSize: 16, fontWeight: 'bold' },
                                    lineStyle: { width: 5 }
                                },
                                symbolSize: 50
                            }]
                        };
                        
                        // ä½¿ç”¨notMergeé˜²æ­¢ç´¯ç§¯é—®é¢˜
                        chart.setOption(option, { notMerge: true, lazyUpdate: true });
                        console.log('å›¾è¡¨æ›´æ–°å®Œæˆ');
                        
                    } catch (error) {
                        console.error('å›¾è¡¨æ›´æ–°å¤±è´¥:', error);
                        throw error;
                    }
                };
                
                // å¼€å§‹æ–°ä¼šè¯
                const startNewSession = async () => {
                    loading.value = true;
                    loadingMessage.value = 'ğŸš€ æ­£åœ¨åˆå§‹åŒ–æ¸è¿›å¼è§„åˆ’ç³»ç»Ÿ...';
                    
                    try {
                        const response = await fetch('http://localhost:8000/api/session/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_input: userInput.value,
                                start_location: startLocation.value,
                                city: city.value,
                                duration: 8.0,
                                budget: 500.0
                            })
                        });
                        
                        if (!response.ok) throw new Error('APIé”™è¯¯');
                        
                        const data = await response.json();
                        console.log('ä¼šè¯åˆ›å»ºæˆåŠŸ:', data);
                        
                        sessionId.value = data.session_id;
                        currentPath.value = [data.start_node.name];
                        currentLevel.value = 0;
                        
                        // æ·»åŠ èµ·ç‚¹èŠ‚ç‚¹
                        graphNodes.value = [data.start_node];
                        graphLinks.value = [];
                        
                        updateChart();
                        updateMap();  // åŒæ­¥æ›´æ–°åœ°å›¾
                        showMessage('âœ…', `ä¼šè¯åˆ›å»ºæˆåŠŸï¼ç‚¹å‡»è“è‰²èµ·ç‚¹ "${data.start_node.name}" å¼€å§‹è§„åˆ’`, 5000);
                        
                    } catch (error) {
                        console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
                        showMessage('âŒ', 'å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯API', 5000);
                    } finally {
                        loading.value = false;
                    }
                };
                
                // å±•å¼€èŠ‚ç‚¹
                const expandNode = async (node) => {
                    if (!sessionId.value) return;
                    
                    loading.value = true;
                    loadingMessage.value = `ğŸ” æ­£åœ¨ä» ${node.name} è§„åˆ’ä¸‹ä¸€æ­¥...`;
                    selectedNode.value = null;
                    
                    try {
                        const response = await fetch('http://localhost:8000/api/session/next', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: sessionId.value,
                                selected_poi_id: node.id,
                                current_time: 14.0
                            })
                        });
                        
                        if (!response.ok) throw new Error('APIé”™è¯¯');
                        
                        const data = await response.json();
                        console.log('=== è·å–ä¸‹ä¸€æ­¥æˆåŠŸ ===');
                        console.log('å“åº”æ•°æ®:', data);
                        console.log('æ–°å¢èŠ‚ç‚¹æ•°:', data.nodes ? data.nodes.length : 0);
                        console.log('æ–°å¢è¾¹æ•°:', data.links ? data.links.length : 0);
                        console.log('å½“å‰è·¯å¾„:', data.current_path);
                        
                        // éªŒè¯æ•°æ®å®Œæ•´æ€§
                        if (!data.nodes || !data.links) {
                            throw new Error('åç«¯è¿”å›æ•°æ®ä¸å®Œæ•´');
                        }
                        
                        console.log('æ·»åŠ æ–°èŠ‚ç‚¹å‰ï¼Œå½“å‰èŠ‚ç‚¹æ•°:', graphNodes.value.length);
                        console.log('æ·»åŠ æ–°è¾¹å‰ï¼Œå½“å‰è¾¹æ•°:', graphLinks.value.length);
                        
                        // æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå·²é€‰æ‹©
                        const currentNode = graphNodes.value.find(n => n.id === node.id);
                        if (currentNode) {
                            currentNode.is_selected = true;
                            currentNode.itemStyle.color = '#3b82f6';
                            currentNode.symbolSize = 60;
                        }
                        
                        // æ£€æŸ¥å¹¶è¿‡æ»¤é‡å¤èŠ‚ç‚¹
                        const existingNodeIds = new Set(graphNodes.value.map(n => n.id));
                        const newNodesToAdd = data.nodes.filter(newNode => {
                            if (existingNodeIds.has(newNode.id)) {
                                console.warn(`âš ï¸ è·³è¿‡é‡å¤èŠ‚ç‚¹: ${newNode.id} (${newNode.name})`);
                                return false;
                            }
                            return true;
                        });
                        
                        console.log(`èŠ‚ç‚¹è¿‡æ»¤: åŸå§‹${data.nodes.length}ä¸ª, æ–°å¢${newNodesToAdd.length}ä¸ª, é‡å¤${data.nodes.length - newNodesToAdd.length}ä¸ª`);
                        
                        // æ·»åŠ ä¸é‡å¤çš„æ–°èŠ‚ç‚¹
                        graphNodes.value.push(...newNodesToAdd);
                        
                        // éªŒè¯è¾¹çš„sourceå’Œtargetæ˜¯å¦éƒ½å­˜åœ¨
                        const nodeIds = new Set(graphNodes.value.map(n => n.id));
                        console.log('éªŒè¯è¾¹: å½“å‰èŠ‚ç‚¹IDæ€»æ•°:', nodeIds.size, '(graphNodes.length:', graphNodes.value.length, ')');
                        
                        const validLinks = data.links.filter(link => {
                            const sourceExists = nodeIds.has(link.source);
                            const targetExists = nodeIds.has(link.target);
                            if (!sourceExists || !targetExists) {
                                console.warn(`âš ï¸ æ— æ•ˆè¾¹: ${link.source} -> ${link.target} (source:${sourceExists}, target:${targetExists})`);
                                return false;
                            }
                            return true;
                        });
                        
                        console.log(`è¾¹éªŒè¯å®Œæˆ: åŸå§‹${data.links.length}æ¡, æœ‰æ•ˆ${validLinks.length}æ¡`);
                        
                        // åªæ·»åŠ æœ‰æ•ˆçš„è¾¹
                        graphLinks.value.push(...validLinks);
                        
                        console.log('æ·»åŠ åèŠ‚ç‚¹æ•°:', graphNodes.value.length);
                        console.log('æ·»åŠ åè¾¹æ•°:', graphLinks.value.length);
                        
                        // ä½¿ç”¨åç«¯è¿”å›çš„è·¯å¾„
                        currentPath.value = data.current_path || currentPath.value;
                        currentLevel.value++;
                        
                        // æ›´æ–°ç»Ÿè®¡
                        totalDistance.value = data.total_distance;
                        totalTime.value = data.total_time;
                        
                        console.log('å¼€å§‹æ›´æ–°å›¾è¡¨...');
                        updateChart();
                        console.log('å›¾è¡¨æ›´æ–°å®Œæˆ');
                        
                        // åŒæ­¥æ›´æ–°åœ°å›¾
                        updateMap();
                        console.log('åœ°å›¾æ›´æ–°å®Œæˆ');
                        
                        // ä¼˜åŒ–æç¤ºä¿¡æ¯
                        if (data.nodes.length > 0) {
                            showMessage('ğŸ¯', `ä» ${node.name} å±•å¼€ ${data.nodes.length} ä¸ªå€™é€‰åœ°ç‚¹ï¼ç‚¹å‡»ç»§ç»­å±•å¼€`, 4000);
                        } else {
                            showMessage('ğŸ', `å·²åˆ°è¾¾ç»ˆç‚¹æˆ–æ— æ›´å¤šæ¨èï¼Œå¯ä»¥å®Œæˆæ—…ç¨‹`, 5000);
                        }
                        
                    } catch (error) {
                        console.error('=== å±•å¼€å¤±è´¥ ===');
                        console.error('é”™è¯¯ç±»å‹:', error.name);
                        console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                        console.error('é”™è¯¯å †æ ˆ:', error.stack);
                        showMessage('âŒ', `å±•å¼€å¤±è´¥: ${error.message}`, 5000);
                    } finally {
                        loading.value = false;
                    }
                };
                
                // é‡ç½®ä¼šè¯
                const resetSession = () => {
                    if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                        sessionId.value = null;
                        currentPath.value = [];
                        currentLevel.value = 0;
                        graphNodes.value = [];
                        graphLinks.value = [];
                        selectedNode.value = null;
                        totalDistance.value = 0;
                        totalTime.value = 0;
                        updateChart();
                        updateMap();  // æ¸…ç©ºåœ°å›¾
                        showMessage('ğŸ”„', 'å·²é‡ç½®ï¼Œå¯ä»¥å¼€å§‹æ–°çš„æ—…ç¨‹');
                    }
                };
                
                // å®Œæˆæ—…ç¨‹
                const finishJourney = () => {
                    showMessage('ğŸ‰', `æ—…ç¨‹å®Œæˆï¼å…±${currentPath.value.length}ä¸ªåœ°ç‚¹ï¼Œ${totalDistance.value.toFixed(1)}km`, 5000);
                };
                
                // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
                const initMap = () => {
                    if (typeof AMap === 'undefined') {
                        console.warn('é«˜å¾·åœ°å›¾APIæœªåŠ è½½ï¼Œè·³è¿‡åœ°å›¾åˆå§‹åŒ–');
                        return;
                    }
                    
                    try {
                        amap = new AMap.Map('map-container', {
                            zoom: 13,
                            center: [120.585315, 31.299379],  // è‹å·ä¸­å¿ƒ
                            mapStyle: 'amap://styles/darkblue',  // æš—è‰²ä¸»é¢˜
                            features: ['bg', 'road', 'building']
                        });
                        
                        console.log('âœ… é«˜å¾·åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                    } catch (error) {
                        console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                    }
                };
                
                // æ›´æ–°åœ°å›¾æ ‡è®°å’Œè·¯å¾„
                const updateMap = () => {
                    if (!amap) return;
                    
                    try {
                        // 1. æ¸…é™¤æ—§æ ‡è®°
                        Object.values(mapMarkers).forEach(marker => marker.setMap(null));
                        mapMarkers = {};
                        
                        // 2. æ·»åŠ æ‰€æœ‰èŠ‚ç‚¹æ ‡è®°
                        graphNodes.value.forEach(node => {
                            if (node.lat && node.lon) {
                                const isInPath = currentPath.value.includes(node.name);
                                
                                const marker = new AMap.Marker({
                                    position: [node.lon, node.lat],
                                    title: node.name,
                                    icon: new AMap.Icon({
                                        size: new AMap.Size(isInPath ? 40 : 30, isInPath ? 40 : 30),
                                        image: `data:image/svg+xml;base64,${btoa(`
                                            <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="20" cy="20" r="${isInPath ? 18 : 12}" 
                                                    fill="${isInPath ? '#3b82f6' : (node.itemStyle?.color || '#10b981')}"
                                                    stroke="${isInPath ? '#60a5fa' : 'white'}" 
                                                    stroke-width="${isInPath ? 3 : 2}"/>
                                            </svg>
                                        `)}`,
                                        imageSize: new AMap.Size(40, 40)
                                    }),
                                    label: {
                                        content: node.name,
                                        direction: 'bottom',
                                        offset: new AMap.Pixel(0, 5)
                                    },
                                    zIndex: isInPath ? 100 : 50
                                });
                                
                                marker.setMap(amap);
                                mapMarkers[node.id] = marker;
                            }
                        });
                        
                        // 3. ç»˜åˆ¶è·¯å¾„çº¿
                        if (mapPolyline) {
                            mapPolyline.setMap(null);
                        }
                        
                        if (currentPath.value.length > 1) {
                            const pathCoords = currentPath.value.map(nodeName => {
                                const node = graphNodes.value.find(n => n.name === nodeName);
                                return node ? [node.lon, node.lat] : null;
                            }).filter(coord => coord !== null);
                            
                            if (pathCoords.length > 1) {
                                mapPolyline = new AMap.Polyline({
                                    path: pathCoords,
                                    strokeColor: '#3b82f6',
                                    strokeWeight: 6,
                                    strokeOpacity: 0.9,
                                    lineJoin: 'round',
                                    zIndex: 10
                                });
                                
                                mapPolyline.setMap(amap);
                                
                                // è‡ªåŠ¨è°ƒæ•´è§†é‡ä»¥æ˜¾ç¤ºæ‰€æœ‰ç‚¹
                                amap.setFitView([mapPolyline]);
                            }
                        }
                        
                        console.log('âœ… åœ°å›¾æ›´æ–°å®Œæˆ:', graphNodes.value.length, 'ä¸ªæ ‡è®°');
                    } catch (error) {
                        console.error('åœ°å›¾æ›´æ–°å¤±è´¥:', error);
                    }
                };
                
                // ç”Ÿå‘½å‘¨æœŸ
                onMounted(() => {
                    initChart();
                    initMap();  // åˆå§‹åŒ–åœ°å›¾
                    showMessage('ğŸ¯', 'æ¬¢è¿ä½¿ç”¨æ¸è¿›å¼æ‹“æ‰‘è§„åˆ’ç³»ç»Ÿï¼Œç‚¹å‡»å·¦ä¾§å¼€å§‹', 4000);
                    
                    window.addEventListener('resize', () => {
                        if (chart) chart.resize();
                    });
                });
                
                return {
                    sessionId, userInput, startLocation, city,
                    currentPath, currentLevel, loading, loadingMessage,
                    aiMessage, aiMessageIcon, graphNodes, graphLinks,
                    selectedNode, totalDistance, totalTime,
                    scoreColor, startNewSession, expandNode,
                    resetSession, finishJourney
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
