<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Horizon | é«˜å¾·ç©ºé—´æ™ºèƒ½ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥ Vue3 å’Œ ECharts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * { box-sizing: border-box; }
        
        body { 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0; 
            font-family: 'Microsoft YaHei', 'PingFang SC', -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        /* éœ“è™¹æ•ˆæœå¢å¼º */
        .neon-text { 
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 40px rgba(59, 130, 246, 0.4); 
        }
        
        /* ç»ç’ƒæ‹Ÿæ€å¢å¼º */
        .glass-panel { 
            background: rgba(30, 41, 59, 0.85); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            border-radius: 4px; 
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.4s ease-out; }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }
        .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }
        
        /* å¾½ç« å¢å¤§ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .badge-green { background: rgba(16, 185, 129, 0.3); color: #10b981; border: 1px solid #10b981; }
        .badge-yellow { background: rgba(251, 191, 36, 0.3); color: #fbbf24; border: 1px solid #fbbf24; }
        .badge-red { background: rgba(239, 68, 68, 0.3); color: #ef4444; border: 1px solid #ef4444; }
        .badge-blue { background: rgba(59, 130, 246, 0.3); color: #3b82f6; border: 1px solid #3b82f6; }
        
        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .weather-btn {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        .weather-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .weather-btn.active {
            transform: scale(1.15);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.8);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="app" class="h-screen flex flex-col">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <header class="h-20 border-b border-slate-700 flex items-center justify-between px-8 bg-slate-900/90 backdrop-blur-sm">
            <div class="flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-green-500 pulse-glow"></div>
                <h1 class="text-2xl font-bold tracking-wider neon-text">
                    EVENT HORIZON
                    <span class="text-sm font-normal text-slate-400 ml-3">æ—¶ç©ºæ™ºèƒ½å¼•æ“ v2.0</span>
                </h1>
            </div>
            
            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-300">åç«¯API</span>
                    <span class="badge" :class="apiConnected ? 'badge-green' : 'badge-red'">
                        {{ apiConnected ? 'â— å·²è¿æ¥' : 'â— ç¦»çº¿æ¨¡å¼' }}
                    </span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-300">é˜»å°¼çŠ¶æ€</span>
                    <span class="badge badge-blue">{{ dampingStatus }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-300">å½“å‰æ—¶é—´</span>
                    <span class="text-sm font-mono text-cyan-400 font-bold">{{ currentTime }}</span>
                </div>
            </div>
        </header>

        <!-- ä¸»ä½“ï¼šä¸‰æ å¸ƒå±€ -->
        <main class="flex-1 flex overflow-hidden">
            
            <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
            <aside class="w-96 border-r border-slate-700 p-6 flex flex-col gap-6 bg-slate-900/50 overflow-y-auto">
                
                <!-- åœºæ™¯æ§åˆ¶ -->
                <div class="space-y-5 animate-fade-in-up">
                    <h3 class="text-base font-bold text-cyan-400 uppercase tracking-widest flex items-center gap-2 mb-4">
                        <span class="text-2xl">ğŸ¯</span>
                        <span>åœºæ™¯æ§åˆ¶ä¸­å¿ƒ</span>
                    </h3>
                    
                    <div class="glass-panel p-5 rounded-xl space-y-5">
                        <!-- åŸå¸‚ -->
                        <div>
                            <label class="text-sm text-slate-300 block mb-3 font-medium">ğŸŒ ç›®çš„åœ°åŸå¸‚</label>
                            <select v-model="city" @change="fetchRecommendations" class="w-full bg-slate-800 border-2 border-slate-600 rounded-lg px-4 py-3 text-base text-slate-200 focus:outline-none focus:border-blue-500 transition">
                                <option value="è‹å·">è‹å·</option>
                                <option value="æ­å·">æ­å·</option>
                                <option value="å—äº¬">å—äº¬</option>
                            </select>
                        </div>
                        
                        <!-- æ—¶é—´æ»‘å— -->
                        <div>
                            <div class="flex justify-between text-base mb-3">
                                <span class="text-slate-300 font-medium">ğŸ• å½“å‰æ—¶é—´</span>
                                <span class="font-mono text-blue-400 font-bold text-lg">{{ currentHour }}:00</span>
                            </div>
                            <input type="range" min="0" max="23" v-model="currentHour" @input="fetchRecommendations" class="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                            <div class="flex justify-between text-xs text-slate-500 mt-2">
                                <span>00:00</span>
                                <span>12:00</span>
                                <span>23:00</span>
                            </div>
                        </div>
                        
                        <!-- å¤©æ°” -->
                        <div>
                            <div class="flex justify-between text-base mb-3">
                                <span class="text-slate-300 font-medium">ğŸŒ¤ï¸ å¤©æ°”çŠ¶å†µ</span>
                                <span class="font-mono font-bold text-lg" :class="weatherColorClass">{{ weather }}</span>
                            </div>
                            <div class="grid grid-cols-4 gap-3">
                                <button @click="setWeather('æ™´')" class="weather-btn py-3 text-2xl rounded-lg bg-slate-700 hover:bg-slate-600 transition" :class="{'active ring-2 ring-blue-500': weather === 'æ™´'}">â˜€ï¸</button>
                                <button @click="setWeather('å¤šäº‘')" class="weather-btn py-3 text-2xl rounded-lg bg-slate-700 hover:bg-slate-600 transition" :class="{'active ring-2 ring-blue-500': weather === 'å¤šäº‘'}">â›…</button>
                                <button @click="setWeather('å°é›¨')" class="weather-btn py-3 text-2xl rounded-lg bg-slate-700 hover:bg-slate-600 transition" :class="{'active ring-2 ring-blue-500': weather === 'å°é›¨'}">ğŸŒ§ï¸</button>
                                <button @click="setWeather('æš´é›¨')" class="weather-btn py-3 text-2xl rounded-lg bg-slate-700 hover:bg-slate-600 transition" :class="{'active ring-2 ring-blue-500': weather === 'æš´é›¨'}">â›ˆï¸</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é˜»å°¼ç³»æ•°ç›‘æ§ -->
                <div class="space-y-4 animate-fade-in-up" style="animation-delay: 0.1s;">
                    <h3 class="text-base font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2 mb-4">
                        <span class="text-2xl">ğŸŒ†</span>
                        <span>æ—¶ç©ºé˜»å°¼ç›‘æ§</span>
                    </h3>
                    
                    <div class="glass-panel p-5 rounded-xl space-y-4 text-sm">
                        <!-- L_zone -->
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-200 font-medium">L_zone (åŒºåŸŸå› å­)</span>
                                <span class="font-mono text-yellow-400 font-bold text-lg">{{ factors.l_zone.toFixed(2) }}</span>
                            </div>
                            <div class="w-full bg-slate-700 h-3 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 transition-all duration-700" :style="{width: (factors.l_zone * 100) + '%'}"></div>
                            </div>
                            <p class="text-slate-400 text-xs mt-2">{{ zoneDescription }}</p>
                        </div>
                        
                        <!-- L_flow -->
                        <div class="pt-3">
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-200 font-medium">L_flow (æ½®æ±å› å­)</span>
                                <span class="font-mono text-purple-400 font-bold text-lg">{{ factors.l_flow.toFixed(2) }}</span>
                            </div>
                            <div class="w-full bg-slate-700 h-3 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-purple-600 to-purple-400 transition-all duration-700" :style="{width: (factors.l_flow * 100) + '%'}"></div>
                            </div>
                            <p class="text-slate-400 text-xs mt-2">{{ flowDescription }}</p>
                        </div>
                        
                        <!-- L_activity -->
                        <div class="pt-3">
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-200 font-medium">L_activity (æ´»åŠ›å› å­)</span>
                                <span class="font-mono text-green-400 font-bold text-lg">{{ factors.l_activity.toFixed(2) }}</span>
                            </div>
                            <div class="w-full bg-slate-700 h-3 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-700" :style="{width: (factors.l_activity * 100) + '%'}"></div>
                            </div>
                            <p class="text-slate-400 text-xs mt-2">LBSçƒ­åŠ›å›¾å®æ—¶è®¡ç®—</p>
                        </div>
                        
                        <!-- ç»¼åˆä¿®æ­£ -->
                        <div class="pt-4 border-t-2 border-slate-700">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-100 font-bold text-base">ç»¼åˆä¿®æ­£ç³»æ•°</span>
                                <span class="text-2xl font-mono font-bold" :class="finalModifierColorClass">{{ finalModifier.toFixed(2) }}x</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åˆ·æ–°æŒ‰é’® -->
                <button @click="fetchRecommendations" :disabled="loading" class="glass-panel p-4 rounded-xl text-base font-bold text-cyan-400 hover:bg-slate-700 transition flex items-center justify-center gap-3" :class="{'opacity-50': loading}">
                    <span v-if="loading" class="inline-block w-5 h-5 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></span>
                    <span v-else>ğŸ”„</span>
                    <span>{{ loading ? 'æ›´æ–°ä¸­...' : 'åˆ·æ–°æ¨è' }}</span>
                </button>
            </aside>

            <!-- ä¸­é—´ï¼šæ‹“æ‰‘ç”»å¸ƒ -->
            <section class="flex-1 relative bg-gradient-to-br from-slate-950 to-slate-900">
                <!-- èƒŒæ™¯ç½‘æ ¼ -->
                <div class="absolute inset-0 opacity-10" style="background-image: repeating-linear-gradient(0deg, #3b82f6 0px, transparent 1px, transparent 50px), repeating-linear-gradient(90deg, #3b82f6 0px, transparent 1px, transparent 50px);"></div>
                
                <!-- å›¾è¡¨ -->
                <div id="graph-container" class="w-full h-full relative z-10"></div>
                
                <!-- AIæ°”æ³¡ -->
                <transition>
                    <div v-if="aiMessage" class="absolute bottom-10 left-1/2 -translate-x-1/2 glass-panel px-8 py-4 rounded-full flex items-center gap-4 shadow-2xl animate-fade-in-up">
                        <span class="text-3xl">ğŸ¤–</span>
                        <span class="text-base font-medium text-cyan-300">{{ aiMessage }}</span>
                    </div>
                </transition>
                
                <!-- å›¾ä¾‹ -->
                <div class="absolute top-8 right-8 glass-panel p-5 rounded-xl text-sm space-y-3">
                    <h4 class="font-bold text-slate-200 mb-4 text-base">ğŸ¨ è¾¹é¢œè‰²å›¾ä¾‹</h4>
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-slate-300">ç•…é€š (â‰¥1.0x)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-2 bg-yellow-500 rounded-full"></div>
                        <span class="text-slate-300">ä¸€èˆ¬ (0.6-1.0x)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-2 bg-red-500 rounded-full"></div>
                        <span class="text-slate-300">æ‹¥å µ (<0.6x)</span>
                    </div>
                </div>
                
                <!-- POIè®¡æ•° -->
                <div class="absolute top-8 left-8 glass-panel px-6 py-4 rounded-xl">
                    <div class="text-xs text-slate-400 mb-1">å½“å‰POIæ•°é‡</div>
                    <div class="text-3xl font-bold font-mono text-blue-400">{{ poiCount }}</div>
                </div>
            </section>

            <!-- å³ä¾§ï¼šè¯¦æƒ…é¢æ¿ -->
            <aside class="w-[450px] border-l border-slate-700 p-6 bg-slate-900/50 overflow-y-auto">
                <div v-if="selectedNode" class="space-y-6 animate-fade-in-up">
                    
                    <!-- POI æ ‡é¢˜ -->
                    <div class="glass-panel rounded-xl overflow-hidden">
                        <div class="h-36 bg-gradient-to-br from-blue-900 via-blue-800 to-slate-900 flex items-center justify-center relative">
                            <div class="absolute inset-0 bg-black opacity-30"></div>
                            <div class="text-center z-10">
                                <h2 class="text-3xl font-bold text-white mb-3">{{ selectedNode.name }}</h2>
                                <div class="flex gap-2 justify-center flex-wrap">
                                    <span class="badge badge-blue text-sm" v-for="tag in selectedNode.tags">{{ tag }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç»¼åˆè¯„åˆ† -->
                    <div class="glass-panel p-6 rounded-xl">
                        <div class="flex items-end justify-between border-b-2 border-slate-700 pb-5 mb-5">
                            <div>
                                <div class="text-sm text-slate-400 mb-2">ç»¼åˆæ¨èæŒ‡æ•°</div>
                                <div class="text-6xl font-bold font-mono" :class="scoreColorClass">{{ selectedNode.score.toFixed(2) }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-slate-400 mb-2">æ—¶ç©ºä¿®æ­£</div>
                                <div class="text-3xl font-mono font-bold" :class="dampingColorClass">{{ selectedNode.damping_factor.toFixed(2) }}x</div>
                            </div>
                        </div>
                        
                        <!-- è¯„åˆ†ç»„æˆ -->
                        <div class="space-y-3 text-base">
                            <div class="flex justify-between">
                                <span class="text-slate-300">åŸºç¡€è¯„åˆ†</span>
                                <span class="font-mono text-slate-100 font-bold">{{ selectedNode.base_score.toFixed(2) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-300">å¤©æ°”ä¿®æ­£</span>
                                <span class="font-mono font-bold" :class="selectedNode.weather_modifier > 1 ? 'text-green-400' : selectedNode.weather_modifier < 1 ? 'text-red-400' : 'text-slate-200'">
                                    {{ selectedNode.weather_modifier.toFixed(2) }}x
                                    {{ selectedNode.weather_modifier > 1 ? 'â¬†ï¸' : selectedNode.weather_modifier < 1 ? 'â¬‡ï¸' : 'â¡ï¸' }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-300">æ—¶ç©ºä¿®æ­£</span>
                                <span class="font-mono font-bold" :class="selectedNode.damping_factor >= 1 ? 'text-green-400' : selectedNode.damping_factor >= 0.6 ? 'text-yellow-400' : 'text-red-400'">
                                    {{ selectedNode.damping_factor.toFixed(2) }}x
                                    {{ selectedNode.damping_factor >= 1 ? 'ğŸŸ¢' : selectedNode.damping_factor >= 0.6 ? 'ğŸŸ¡' : 'ğŸ”´' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- AI æ¨èç†ç”± -->
                    <div class="glass-panel p-5 rounded-xl space-y-3">
                        <h4 class="text-base font-bold text-slate-200 flex items-center gap-2">
                            <span class="text-2xl">ğŸ§ </span>
                            <span>AI å†³ç­–é€»è¾‘</span>
                        </h4>
                        <div class="p-4 rounded-lg bg-slate-800/70 border-2 border-slate-700 text-base leading-relaxed text-slate-200">
                            {{ selectedNode.reason }}
                        </div>
                    </div>

                    <!-- æ‹¥å µè­¦å‘Š -->
                    <div v-if="selectedNode.is_blocked" class="glass-panel p-5 rounded-xl bg-red-900/30 border-2 border-red-500/70 pulse-glow">
                        <div class="flex gap-4 items-start">
                            <span class="text-3xl">â›”</span>
                            <div>
                                <h5 class="font-bold text-red-400 text-base uppercase mb-3">æ‹¥å µç†”æ–­è­¦å‘Š</h5>
                                <p class="text-base text-red-200 leading-relaxed">{{ selectedNode.block_reason }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- å››é¡¹åŸåˆ™ -->
                    <div class="glass-panel p-5 rounded-xl space-y-4">
                        <h4 class="text-base font-bold text-slate-200 flex items-center gap-2">
                            <span class="text-2xl">ğŸ”</span>
                            <span>å››é¡¹åŸåˆ™éªŒè¯</span>
                        </h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-slate-800/70 p-4 rounded-lg border border-slate-700">
                                <div class="text-slate-400 mb-2">æ•°æ®ä¸€è‡´æ€§</div>
                                <div class="font-mono font-bold text-green-400 text-xl">{{ selectedNode.verification.consistency }}%</div>
                            </div>
                            <div class="bg-slate-800/70 p-4 rounded-lg border border-slate-700">
                                <div class="text-slate-400 mb-2">è™šå‡ç‡</div>
                                <div class="font-mono font-bold text-blue-400 text-xl">{{ selectedNode.verification.fake_rate }}%</div>
                            </div>
                            <div class="bg-slate-800/70 p-4 rounded-lg border border-slate-700">
                                <div class="text-slate-400 mb-2">ç©ºé—´åˆç†æ€§</div>
                                <div class="font-mono font-bold text-yellow-400 text-xl">{{ selectedNode.verification.spatial }}</div>
                            </div>
                            <div class="bg-slate-800/70 p-4 rounded-lg border border-slate-700">
                                <div class="text-slate-400 mb-2">æ—¶é—´å¯è¡Œæ€§</div>
                                <div class="font-mono font-bold text-purple-400 text-xl">{{ selectedNode.verification.temporal }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸‹ä¸€æ­¥é¢„è§ˆ -->
                    <div v-if="selectedNode.future_preview && selectedNode.future_preview.length > 0" class="glass-panel p-5 rounded-xl">
                        <h4 class="text-base font-bold text-slate-200 flex items-center gap-2 mb-4">
                            <span class="text-2xl">ğŸ”®</span>
                            <span>é€‰æ‹©åå¯èƒ½å»</span>
                        </h4>
                        <div class="flex flex-wrap gap-2">
                            <span v-for="poi in selectedNode.future_preview" class="badge badge-green text-sm">{{ poi }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- æœªé€‰æ‹©çŠ¶æ€ -->
                <div v-else class="h-full flex flex-col items-center justify-center text-slate-600 space-y-6">
                    <div class="text-8xl opacity-30">ğŸ—ºï¸</div>
                    <div class="text-center">
                        <p class="font-medium text-slate-400 text-lg mb-2">ç‚¹å‡»æ‹“æ‰‘èŠ‚ç‚¹</p>
                        <p class="text-base text-slate-500">æŸ¥çœ‹ AI åˆ†æè¯¦æƒ…</p>
                    </div>
                </div>
            </aside>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // ========== çŠ¶æ€ ==========
                const city = ref('è‹å·');
                const currentHour = ref(14);
                const weather = ref('å°é›¨');
                const selectedNode = ref(null);
                const aiMessage = ref('');
                const loading = ref(false);
                const apiConnected = ref(false);
                
                const factors = ref({
                    l_zone: 1.0,
                    l_flow: 1.0,
                    l_activity: 1.1
                });
                
                const graphData = ref({
                    nodes: [],
                    links: []
                });
                
                const poiCount = ref(0);
                
                // ========== è®¡ç®—å±æ€§ ==========
                const currentTime = computed(() => `${String(currentHour.value).padStart(2, '0')}:00`);
                
                const weatherColorClass = computed(() => {
                    return weather.value === 'æ™´' ? 'text-yellow-400' :
                           weather.value === 'å¤šäº‘' ? 'text-slate-400' :
                           'text-blue-400';
                });
                
                const scoreColorClass = computed(() => {
                    if (!selectedNode.value) return '';
                    const score = selectedNode.value.score;
                    return score >= 0.8 ? 'text-green-400' :
                           score >= 0.6 ? 'text-yellow-400' :
                           'text-red-400';
                });
                
                const dampingColorClass = computed(() => {
                    if (!selectedNode.value) return '';
                    const damping = selectedNode.value.damping_factor;
                    return damping >= 1.0 ? 'text-green-400' :
                           damping >= 0.6 ? 'text-yellow-400' :
                           'text-red-400';
                });
                
                const finalModifier = computed(() => {
                    return factors.value.l_zone * factors.value.l_flow * factors.value.l_activity;
                });
                
                const finalModifierColorClass = computed(() => {
                    const modifier = finalModifier.value;
                    return modifier >= 1.0 ? 'text-green-400' :
                           modifier >= 0.6 ? 'text-yellow-400' :
                           'text-red-400';
                });
                
                const dampingStatus = computed(() => {
                    const modifier = finalModifier.value;
                    return modifier >= 1.0 ? 'ğŸŸ¢ ç•…é€š' :
                           modifier >= 0.6 ? 'ğŸŸ¡ ä¸€èˆ¬' :
                           'ğŸ”´ æ‹¥å µ';
                });
                
                const zoneDescription = computed(() => {
                    const zone = factors.value.l_zone;
                    return zone >= 1.0 ? 'æ™®é€šåŒºåŸŸï¼Œé€šè¡Œæ­£å¸¸' :
                           zone >= 0.6 ? 'CBDåŒºåŸŸï¼Œè½»åº¦æ‹¥å µ' :
                           'æ ¸å¿ƒåŒºåŸŸï¼Œä¸¥é‡æ‹¥å µ';
                });
                
                const flowDescription = computed(() => {
                    const hour = currentHour.value;
                    if (hour >= 7 && hour <= 9) return 'æ—©é«˜å³°ï¼Œè¿›åŸæ–¹å‘æ‹¥å µ';
                    if (hour >= 17 && hour <= 19) return 'æ™šé«˜å³°ï¼Œå‡ºåŸæ–¹å‘æ‹¥å µ';
                    return 'éé«˜å³°æ—¶æ®µï¼Œé€šè¡Œé¡ºç•…';
                });

                // ========== ECharts ==========
                let chart = null;
                
                const initChart = () => {
                    chart = echarts.init(document.getElementById('graph-container'));
                    updateChart();
                    
                    chart.on('click', (params) => {
                        if (params.dataType === 'node') {
                            selectedNode.value = params.data;
                            
                            if (params.data.id !== '0') {
                                aiMessage.value = `ğŸ§  å·²é€‰æ‹© "${params.data.name}"ï¼ŒæŸ¥çœ‹å³ä¾§è¯¦æƒ…`;
                                setTimeout(() => { aiMessage.value = ''; }, 2500);
                            }
                        }
                    });
                };
                
                const updateChart = () => {
                    if (!chart) return;
                    
                    const option = {
                        tooltip: { show: false },
                        animationDuration: 1000,
                        animationEasing: 'cubicOut',
                        series: [{
                            type: 'graph',
                            layout: 'none',
                            roam: true,
                            label: {
                                show: true,
                                position: 'bottom',
                                color: '#e2e8f0',
                                fontSize: 14,
                                fontWeight: 'bold',
                                formatter: '{b}'
                            },
                            edgeSymbol: ['circle', 'arrow'],
                            edgeSymbolSize: [5, 12],
                            data: graphData.value.nodes,
                            links: graphData.value.links,
                            lineStyle: {
                                opacity: 0.9,
                                curveness: 0.2
                            },
                            emphasis: {
                                focus: 'adjacency',
                                label: { fontSize: 16 },
                                lineStyle: { width: 5 }
                            }
                        }]
                    };
                    
                    chart.setOption(option, true);
                };
                
                // ========== API ==========
                const fetchRecommendations = async () => {
                    loading.value = true;
                    aiMessage.value = 'ğŸ”„ æ­£åœ¨è®¡ç®—æœ€ä¼˜æ¨è...';
                    
                    try {
                        const response = await fetch(
                            `http://localhost:8000/api/recommendations?city=${city.value}&current_hour=${currentHour.value}&weather_condition=${weather.value}`
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            graphData.value = data;
                            factors.value = data.factors;
                            poiCount.value = data.nodes.length - 1;
                            apiConnected.value = true;
                            aiMessage.value = `âœ… å·²ä¸ºæ‚¨æ¨è ${poiCount.value} ä¸ªåœ°ç‚¹`;
                        } else {
                            throw new Error('API error');
                        }
                    } catch (error) {
                        console.warn('APIç¦»çº¿ï¼Œä½¿ç”¨Mockæ•°æ®');
                        apiConnected.value = false;
                        loadMockData();
                        aiMessage.value = 'âš ï¸ åç«¯ç¦»çº¿ï¼Œæ­£åœ¨ä½¿ç”¨æ¼”ç¤ºæ•°æ®';
                    }
                    
                    setTimeout(() => { aiMessage.value = ''; }, 3000);
                    loading.value = false;
                    updateChart();
                };
                
                const loadMockData = () => {
                    // Mockæ•°æ®
                    const hour = parseInt(currentHour.value);
                    
                    if (hour >= 17 && hour <= 19) {
                        factors.value = { l_zone: 0.30, l_flow: 1.00, l_activity: 1.10 };
                    } else if (hour >= 7 && hour <= 9) {
                        factors.value = { l_zone: 0.60, l_flow: 1.00, l_activity: 1.10 };
                    } else {
                        factors.value = { l_zone: 1.00, l_flow: 1.00, l_activity: 1.10 };
                    }
                    
                    graphData.value = {
                        nodes: [
                            {
                                id: '0', name: 'è‹å·ç«™', symbolSize: 60,
                                itemStyle: { color: '#3b82f6' },
                                x: 200, y: 350,
                                tags: ['èµ·ç‚¹'], score: 1.0, base_score: 1.0,
                                weather_modifier: 1.0, damping_factor: 1.0,
                                reason: 'å‡ºå‘ç‚¹',
                                verification: { consistency: 100, fake_rate: 0, spatial: 1.0, temporal: 1.0 },
                                future_preview: [], is_blocked: false
                            },
                            {
                                id: '1', name: 'æ‹™æ”¿å›­', symbolSize: 45,
                                itemStyle: { color: weather.value.includes('é›¨') ? '#ef4444' : '#10b981' },
                                x: 500, y: 200,
                                tags: ['å›­æ—', 'æˆ·å¤–', '5A'],
                                score: weather.value.includes('é›¨') ? 0.56 : 0.96,
                                base_score: 0.80,
                                weather_modifier: weather.value.includes('é›¨') ? 0.70 : 1.20,
                                damping_factor: factors.value.l_zone,
                                reason: weather.value.includes('é›¨') ? 'é›¨å¤©æˆ·å¤–æ¸¸è§ˆå—å½±å“ï¼Œå»ºè®®æºå¸¦é›¨å…·' : 'æ±Ÿå—å›­æ—ä»£è¡¨ä½œï¼Œæ™´å¤©æ¸¸è§ˆæœ€ä½³',
                                verification: { consistency: 96, fake_rate: 0, spatial: 0.82, temporal: 0.84 },
                                future_preview: ['å¹³æ±Ÿè·¯', 'ç‹®å­æ—'],
                                is_blocked: false
                            },
                            {
                                id: '2', name: 'è‹å·åšç‰©é¦†', symbolSize: 50,
                                itemStyle: { color: weather.value.includes('é›¨') ? '#10b981' : '#fbbf24' },
                                x: 500, y: 350,
                                tags: ['åšç‰©é¦†', 'å®¤å†…', 'æ–‡åŒ–'],
                                score: weather.value.includes('é›¨') ? 0.96 : 0.80,
                                base_score: 0.80,
                                weather_modifier: weather.value.includes('é›¨') ? 1.20 : 1.00,
                                damping_factor: factors.value.l_zone,
                                reason: weather.value.includes('é›¨') ? 'é›¨å¤©å®¤å†…åœºé¦†æ˜¯æœ€ä¼˜é€‰æ‹©ï¼Œä¸å—å¤©æ°”å½±å“' : 'è´è¿é“­è®¾è®¡çš„ç°ä»£åšç‰©é¦†ï¼Œå€¼å¾—å‚è§‚',
                                verification: { consistency: 96, fake_rate: 0, spatial: 0.82, temporal: 0.84 },
                                future_preview: ['å¹³æ±Ÿè·¯', 'ç‹®å­æ—'],
                                is_blocked: false
                            },
                            {
                                id: '3', name: 'é‡‘é¸¡æ¹–CBD', symbolSize: 40,
                                itemStyle: { color: factors.value.l_zone < 0.6 ? '#ef4444' : '#fbbf24' },
                                x: 500, y: 500,
                                tags: ['CBD', 'å•†ä¸š'],
                                score: 0.80 * factors.value.l_zone,
                                base_score: 0.80,
                                weather_modifier: 1.00,
                                damping_factor: factors.value.l_zone,
                                reason: factors.value.l_zone < 0.6 ? 'CBDåŒºåŸŸæ‹¥å µï¼Œå»ºè®®é¿å¼€' : 'CBDå•†ä¸šåŒºï¼Œè´­ç‰©ä¼‘é—²',
                                verification: { consistency: 95, fake_rate: 0, spatial: 0.80, temporal: 0.85 },
                                future_preview: ['è¯šå“ä¹¦åº—'],
                                is_blocked: factors.value.l_zone < 0.6,
                                block_reason: factors.value.l_zone < 0.6 ? 'æ™šé«˜å³°CBDä¸¥é‡æ‹¥å µï¼Œç³»ç»Ÿå·²è§¦å‘ç†”æ–­' : null
                            }
                        ],
                        links: [
                            {
                                source: '0', target: '1',
                                lineStyle: {
                                    width: factors.value.l_zone >= 1 ? 3 : 2,
                                    color: factors.value.l_zone >= 1 ? '#10b981' : '#fbbf24',
                                    curveness: 0.2
                                }
                            },
                            {
                                source: '0', target: '2',
                                lineStyle: {
                                    width: 3,
                                    color: '#10b981',
                                    curveness: 0.2
                                }
                            },
                            {
                                source: '0', target: '3',
                                lineStyle: {
                                    width: factors.value.l_zone < 0.6 ? 1 : 2,
                                    color: factors.value.l_zone < 0.6 ? '#ef4444' : '#fbbf24',
                                    type: factors.value.l_zone < 0.6 ? 'dashed' : 'solid',
                                    curveness: 0.2
                                }
                            }
                        ]
                    };
                    
                    poiCount.value = 3;
                };
                
                const setWeather = (w) => {
                    weather.value = w;
                    fetchRecommendations();
                };
                
                // ========== ç”Ÿå‘½å‘¨æœŸ ==========
                onMounted(() => {
                    initChart();
                    fetchRecommendations();
                    
                    window.addEventListener('resize', () => {
                        if (chart) chart.resize();
                    });
                });
                
                return {
                    city, currentHour, weather, selectedNode, aiMessage, loading,
                    apiConnected, factors, poiCount,
                    currentTime, weatherColorClass, scoreColorClass, dampingColorClass,
                    finalModifier, finalModifierColorClass, dampingStatus,
                    zoneDescription, flowDescription,
                    fetchRecommendations, setWeather
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
